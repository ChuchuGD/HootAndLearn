<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asignaci√≥n de Evaluaciones</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
 <link rel="stylesheet" href="./evaluaciones.css">
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="app-title">üìã Asignaci√≥n de Evaluaciones</h1>
    <p id="welcome-message">Asigna evaluaciones a estudiantes y grupos de forma organizada</p>
   </div>
   <div class="actions-bar"><button class="btn btn-primary" id="create-assignment-btn"> ‚ûï Nueva Asignaci√≥n </button> <button class="btn btn-secondary" id="manage-students-btn"> üë• Gestionar Estudiantes </button> <button class="btn btn-secondary" id="manage-groups-btn"> üè´ Gestionar Grupos </button>
   </div>
   <div class="filter-bar">
    <div class="filter-group"><label for="status-filter">Estado:</label> <select id="status-filter"> <option value="all">Todos</option> <option value="active">Activos</option> <option value="pending">Pendientes</option> <option value="overdue">Vencidos</option> </select>
    </div>
    <div class="filter-group"><label for="search-filter">Buscar:</label> <input type="text" id="search-filter" placeholder="T√≠tulo de evaluaci√≥n..." style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
    </div>
   </div>
   <div id="assignments-container"></div>
  </div><div class="modal" id="assignment-modal">
   <div class="modal-content">
    <h2 id="modal-title">üìù Nueva Asignaci√≥n de Evaluaci√≥n</h2>
    <form id="assignment-form">
     <div class="form-group"><label for="eval-title">T√≠tulo de la Evaluaci√≥n</label> <input type="text" id="eval-title" required placeholder="Ej: Examen Final de Matem√°ticas">
     </div>
     <div class="form-group"><label for="eval-description">Descripci√≥n</label> <textarea id="eval-description" required placeholder="Describe los objetivos y contenido de la evaluaci√≥n"></textarea>
     </div>
     <div class="form-row">
      <div class="form-group"><label for="eval-due-date">Fecha de Entrega</label> <input type="datetime-local" id="eval-due-date" required>
      </div>
      <div class="form-group"><label for="eval-max-score">Puntuaci√≥n M√°xima</label> <input type="number" id="eval-max-score" required min="1" value="100">
      </div>
     </div>
     <div class="form-group"><label for="eval-instructions">Instrucciones Especiales</label> <textarea id="eval-instructions" placeholder="Instrucciones adicionales para los estudiantes"></textarea>
     </div>
     
     <div class="form-group">
        <label for="select-curso-asignacion">Asignar a Curso</label>
        <select id="select-curso-asignacion" required>
            <option value="">Selecciona un Curso...</option>
            </select>
     </div>
     <div class="groups-selector">
      <h4>üè´ Seleccionar Grupos (del Curso Seleccionado)</h4>
      <div class="groups-grid" id="groups-grid"></div>
     </div>
     <div class="student-selector">
      <h4>üë• Seleccionar Estudiantes (del Curso/Grupo Seleccionado)</h4>
      <div class="students-grid" id="students-grid"></div>
     </div>
     <div class="modal-actions"><button type="button" class="btn btn-secondary" id="cancel-assignment-btn">Cancelar</button> <button type="submit" class="btn btn-primary" id="submit-assignment-btn">Crear Asignaci√≥n</button>
     </div>
    </form>
   </div>
  </div><div class="modal" id="students-modal">
   <div class="modal-content">
    <h2>üë• Gestionar Estudiantes</h2>
    <div class="form-group"><label for="new-student">Agregar Nuevo Estudiante</label>
     <div style="display: flex; gap: 12px;"><input type="text" id="new-student" placeholder="Nombre del estudiante" style="flex: 1;"> <button type="button" class="btn btn-success" id="add-student-btn">Agregar</button>
     </div>
    </div>
    <div id="students-list"></div>
    <div class="modal-actions"><button type="button" class="btn btn-secondary" id="close-students-btn">Cerrar</button>
    </div>
   </div>
  </div><div class="modal" id="groups-modal">
   <div class="modal-content">
    <h2>üè´ Gestionar Grupos</h2>
    <div class="form-group"><label for="new-group">Agregar Nuevo Grupo</label>
     <div style="display: flex; gap: 12px;"><input type="text" id="new-group" placeholder="Nombre del grupo" style="flex: 1;"> <button type="button" class="btn btn-success" id="add-group-btn">Agregar</button>
     </div>
    </div>
    <div id="groups-list"></div>
    <div class="modal-actions"><button type="button" class="btn btn-secondary" id="close-groups-btn">Cerrar</button>
    </div>
   </div>
  </div><div class="toast" id="toast"></div>
  <script>
    const defaultConfig = {
      app_title: "üìã Asignaci√≥n de Evaluaciones",
      welcome_message: "Asigna evaluaciones a estudiantes y grupos de forma organizada",
      primary_color: "#4f46e5",
      secondary_color: "#ffffff",
      text_color: "#1e293b",
      success_color: "#10b981",
      danger_color: "#ef4444"
    };
    
    let assignments = [];
    let students = []; // Estudiantes del curso seleccionado
    let groups = [];   // Grupos del curso seleccionado
    let courses = [];  // Cursos del profesor
    let currentCursoID = null; 

    // Funci√≥n de utilidad para mapear ID a nombre
    const getStudentName = (id) => students.find(s => s.EstID == id)?.NombreCompleto || `EstID ${id}`;
    const getGroupName = (id) => groups.find(g => g.GrupoID == id)?.NombreGrupo || `GrupoID ${id}`;
    
    const dataHandler = {
      onDataChanged(data) {
        assignments = data;
        renderAssignments();
      }
    };
    
    async function fetchFromBackend(accion, params = {}) {
        const urlParams = new URLSearchParams(params);
        try {
            const response = await fetch(`obtener_datos_evaluacion.php?accion=${accion}&${urlParams}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            return data;
        } catch (error) {
            console.error(`Error fetching ${accion}:`, error);
            showToast(`Error al cargar ${accion}. Ver consola.`, 'error');
            return [];
        }
    }

    async function initializeApp() {
      // 1. Inicializar SDK (si es necesario)
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        // showToast('Error al inicializar el sistema', 'error');
        console.error('Failed to initialize data SDK');
      }
      
      // 2. Cargar Cursos del profesor al inicio
      courses = await fetchFromBackend('cursos');
      renderCourseSelector();
      
      // 3. Cargar listas iniciales (o vac√≠as)
      loadStudentsAndGroups(null);
      renderAssignments();
    }
    
    function renderCourseSelector() {
        const select = document.getElementById('select-curso-asignacion');
        select.innerHTML = '<option value="">Selecciona un Curso...</option>';
        courses.forEach(curso => {
            const opt = document.createElement("option");
            opt.value = curso.CursoID;
            opt.textContent = curso.NombreCurso;
            select.appendChild(opt);
        });
    }

    // L√≥gica de cascada al cambiar el curso seleccionado
    document.getElementById('select-curso-asignacion').addEventListener('change', async (e) => {
        currentCursoID = e.target.value;
        if (currentCursoID) {
            await loadStudentsAndGroups(currentCursoID);
        } else {
            // Limpiar si no hay curso seleccionado
            students = [];
            groups = [];
            renderStudentsGrid();
            renderGroupsGrid();
        }
        // Limpiar selecciones de estudiantes y grupos al cambiar de curso
        document.querySelectorAll('.student-item, .group-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('input[type="checkbox"]').checked = false;
        });
    });

    // Esta funci√≥n ahora usa el CursoID para cargar datos
    async function loadStudentsAndGroups(cursoID) {
        if (!cursoID) {
            students = [];
            groups = [];
        } else {
            // 1. Cargar Alumnos del Curso
            students = await fetchFromBackend('alumnos', { cursoID: cursoID });
            // 2. Cargar Grupos del Curso
            groups = await fetchFromBackend('grupos', { cursoID: cursoID });
        }
        
        // 3. Renderizar las listas y grids con datos del curso
        renderStudentsGrid(); // Llama sin argumentos para mostrar todos los del curso por defecto
        renderGroupsGrid();
        // Las listas de gesti√≥n (students-modal) solo se actualizan al abrirlas si es necesario
    }
    
    // Esta funci√≥n debe reaccionar a la SELECCI√ìN DE GRUPOS
    document.getElementById('groups-grid').addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            updateStudentsGridByGroupSelection();
        }
    });

    function getSelectedGroupIDs() {
        return Array.from(document.querySelectorAll('#groups-grid input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
    }
    
    // Filtra y muestra solo los alumnos que pertenecen al grupo/curso seleccionado
    async function updateStudentsGridByGroupSelection() {
        const selectedGroupIDs = getSelectedGroupIDs();
        
        let studentsToShow = students;

        if (selectedGroupIDs.length > 0) {
            // Llamada al endpoint PHP modificado: alumnosPorGrupos
            const alumnosPorGrupos = await fetchFromBackend('alumnosPorGrupos', { groupIDs: selectedGroupIDs.join(',') });
            // Solo mostramos los estudiantes que est√°n en el curso actual (redundante si la DB es correcta, pero seguro)
            studentsToShow = alumnosPorGrupos.filter(a => students.some(s => s.EstID === a.EstID));
        }

        renderStudentsGrid(studentsToShow);
    }
    
    // Ahora puede recibir una lista de estudiantes a renderizar
    function renderStudentsGrid(studentsList = students) {
      const grid = document.getElementById('students-grid');
      // Limpiar antes de re-renderizar
      grid.innerHTML = '';

      if (!currentCursoID) {
          grid.innerHTML = '<p style="color: #6b7280; font-style: italic; padding: 10px;">Selecciona un curso primero.</p>';
          return;
      }

      if (studentsList.length === 0) {
          grid.innerHTML = '<p style="color: #6b7280; font-style: italic; padding: 10px;">No hay estudiantes registrados en este curso o grupo(s).</p>';
          return;
      }

      grid.innerHTML = studentsList.map((student) => `
        <div class="student-item" data-id="${student.EstID}">
          <input type="checkbox" id="student-${student.EstID}" value="${student.EstID}">
          <label for="student-${student.EstID}">${student.NombreCompleto}</label>
        </div>
      `).join('');
      
      grid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const item = e.target.closest('.student-item');
          item.classList.toggle('selected', e.target.checked);
        });
      });
    }
    
    function renderGroupsGrid() {
      const grid = document.getElementById('groups-grid');
      // Limpiar antes de re-renderizar
      grid.innerHTML = '';
      
      if (!currentCursoID) {
          grid.innerHTML = '<p style="color: #6b7280; font-style: italic; padding: 10px;">Selecciona un curso primero.</p>';
          return;
      }
      if (groups.length === 0) {
          grid.innerHTML = '<p style="color: #6b7280; font-style: italic; padding: 10px;">No hay grupos registrados en este curso.</p>';
          return;
      }
      
      grid.innerHTML = groups.map((group) => `
        <div class="group-item" data-id="${group.GrupoID}">
          <input type="checkbox" id="group-${group.GrupoID}" value="${group.GrupoID}">
          <label for="group-${group.GrupoID}">${group.NombreGrupo}</label>
        </div>
      `).join('');
      
      grid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const item = e.target.closest('.group-item');
          item.classList.toggle('selected', e.target.checked);
        });
      });
    }
    
    // L√≥gica para abrir el modal (Soluci√≥n al problema anterior)
    function openAssignmentModal() {
      document.getElementById('assignment-form').reset();
      document.getElementById('modal-title').textContent = 'üìù Nueva Asignaci√≥n de Evaluaci√≥n';
      document.getElementById('submit-assignment-btn').textContent = 'Crear Asignaci√≥n';
      delete document.getElementById('assignment-form').dataset.editId;
      
      // Limpiar el selector de curso y los grids de asignaci√≥n al abrir
      document.getElementById('select-curso-asignacion').value = '';
      currentCursoID = null;
      loadStudentsAndGroups(null); // Limpiar estudiantes y grupos
      
      // Limpiar selecciones
      document.querySelectorAll('.student-item, .group-item').forEach(item => {
        item.classList.remove('selected');
        item.querySelector('input[type="checkbox"]').checked = false;
      });
      
      // Establecer fecha por defecto (una semana desde hoy)
      const nextWeek = new Date();
      nextWeek.setDate(nextWeek.getDate() + 7);
      const dueDateInput = document.getElementById('eval-due-date');
      if (dueDateInput) {
          dueDateInput.value = nextWeek.toISOString().slice(0, 16);
      }
      
      document.getElementById('assignment-modal').classList.add('active');
    }
    
    // L√≥gica de visualizaci√≥n y filtrado (simplificada)
    function getAssignmentStatus(assignment) {
      const dueDate = new Date(assignment.dueDate);
      const now = new Date();
      if (dueDate < now) return 'overdue';
      if (dueDate - now < 24 * 60 * 60 * 1000) return 'pending';
      return 'active';
    }
    
    function getStatusText(status) {
      switch (status) {
        case 'active': return 'Activo';
        case 'pending': return 'Pr√≥ximo';
        case 'overdue': return 'Vencido';
        default: return 'Activo';
      }
    }
    
    function filterAssignments() {
        const statusFilter = document.getElementById('status-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();
        
        return assignments.filter(assignment => {
            const matchesStatus = statusFilter === 'all' || getAssignmentStatus(assignment) === statusFilter;
            const matchesSearch = assignment.evaluationTitle.toLowerCase().includes(searchFilter) ||
                                assignment.description.toLowerCase().includes(searchFilter);
            return matchesStatus && matchesSearch;
        });
    }

    function renderAssignments() {
      const container = document.getElementById('assignments-container');
      const filteredAssignments = filterAssignments();
      
      if (filteredAssignments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>No hay asignaciones</h3>
            <p>Comienza creando tu primera asignaci√≥n de evaluaci√≥n para organizar el trabajo de tus estudiantes</p>
            <button class="btn btn-primary" onclick="openAssignmentModal()">Crear Primera Asignaci√≥n</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `<div class="assignments-grid">${filteredAssignments.map(assignment => {
        const status = getAssignmentStatus(assignment);
        const dueDate = new Date(assignment.dueDate);
        const assignedStudents = assignment.assignedStudents ? JSON.parse(assignment.assignedStudents) : [];
        const assignedGroups = assignment.assignedGroups ? JSON.parse(assignment.assignedGroups) : [];
        
        return `
          <div class="assignment-card ${status}" data-id="${assignment.id}">
            <div class="assignment-header">
              <h3 class="assignment-title">${assignment.evaluationTitle}</h3>
              <span class="status-badge ${status}">${getStatusText(status)}</span>
            </div>
            
            <p class="assignment-description">${assignment.description}</p>
            
            <div class="assigned-to">
              <h4>üë• Estudiantes Asignados (${assignedStudents.length})</h4>
              <div class="assigned-students">
                ${assignedStudents.slice(0, 5).map(id => `<span class="student-tag">${getStudentName(id)}</span>`).join('')}
                ${assignedStudents.length > 5 ? `<span class="student-tag">+${assignedStudents.length - 5} m√°s</span>` : ''}
              </div>
            </div>
            
            <div class="card-actions">
              <button class="btn btn-primary view-btn" data-id="${assignment.id}">Ver Detalles</button>
            </div>
          </div>
        `;
      }).join('')}</div>`;
      
      document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', (e) => viewAssignmentDetails(e.target.dataset.id)));
      document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => editAssignment(e.target.dataset.id)));
      document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteAssignment(e.target.dataset.id)));
    }

    function viewAssignmentDetails(id) {
        const assignment = assignments.find(a => a.id === id);
        if (!assignment) return;
        
        const assignedStudentsIDs = assignment.assignedStudents ? JSON.parse(assignment.assignedStudents) : [];
        const assignedGroupsIDs = assignment.assignedGroups ? JSON.parse(assignment.assignedGroups) : [];
        const dueDate = new Date(assignment.dueDate);

        const studentNames = assignedStudentsIDs.map(id => getStudentName(id));
        const groupNames = assignedGroupsIDs.map(id => getGroupName(id));
        
        showToast(`
          üìã ${assignment.evaluationTitle}
          
          üìÖ Entrega: ${dueDate.toLocaleDateString('es-ES')} ${dueDate.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
          
          üë• Estudiantes: ${studentNames.join(', ')}
          üè´ Grupos: ${groupNames.join(', ')}
          
          üìù Instrucciones: ${assignment.instructions || 'Sin instrucciones especiales'}
        `, 'success');
    }

    function editAssignment(id) {
        const assignment = assignments.find(a => a.id === id);
        if (!assignment) return;
        
        document.getElementById('eval-title').value = assignment.evaluationTitle;
        document.getElementById('eval-description').value = assignment.description;
        document.getElementById('eval-due-date').value = new Date(assignment.dueDate).toISOString().slice(0, 16);
        document.getElementById('eval-max-score').value = assignment.maxScore;
        document.getElementById('eval-instructions').value = assignment.instructions || '';
        document.getElementById('select-curso-asignacion').value = assignment.cursoID;

        const assignedStudentsIDs = assignment.assignedStudents ? JSON.parse(assignment.assignedStudents) : [];
        const assignedGroupsIDs = assignment.assignedGroups ? JSON.parse(assignment.assignedGroups) : [];
        
        // Recargar datos y marcar selecciones
        loadStudentsAndGroups(assignment.cursoID).then(() => {
            document.querySelectorAll('#students-grid input[type="checkbox"]').forEach(checkbox => {
              checkbox.checked = assignedStudentsIDs.includes(parseInt(checkbox.value));
              checkbox.closest('.student-item').classList.toggle('selected', checkbox.checked);
            });
            document.querySelectorAll('#groups-grid input[type="checkbox"]').forEach(checkbox => {
              checkbox.checked = assignedGroupsIDs.includes(parseInt(checkbox.value));
              checkbox.closest('.group-item').classList.toggle('selected', checkbox.checked);
            });
        });
        
        document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar Asignaci√≥n';
        document.getElementById('submit-assignment-btn').textContent = 'Actualizar Asignaci√≥n';
        document.getElementById('assignment-form').dataset.editId = id;
        
        document.getElementById('assignment-modal').classList.add('active');
    }
    
    async function deleteAssignment(id) {
        const assignment = assignments.find(a => a.id === id);
        if (!assignment) return;
        
        const card = document.querySelector(`[data-id="${id}"]`);
        const deleteBtn = card.querySelector('.delete-btn');
        
        if (deleteBtn.textContent === 'Eliminar') {
            deleteBtn.textContent = '¬øConfirmar?';
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-secondary');
            
            setTimeout(() => {
                if (deleteBtn.textContent === '¬øConfirmar?') {
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.classList.remove('btn-secondary');
                    deleteBtn.classList.add('btn-danger');
                }
            }, 3000);
            return;
        }
        
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<span class="spinner"></span>Eliminando...';
        
        // Simulaci√≥n de eliminaci√≥n (Si usas el SDK, descomenta la l√≠nea de result)
        // const result = await window.dataSdk.delete(assignment);
        const result = { isOk: true }; // Simulaci√≥n de √©xito

        if (result.isOk) {
            showToast('Asignaci√≥n eliminada exitosamente', 'success');
            // Recargar la lista de asignaciones si es necesario
        } else {
            showToast('Error al eliminar la asignaci√≥n', 'error');
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Eliminar';
        }
    }

    // Funciones para gestionar listas (Simulaci√≥n local)
    function renderStudentsList() {
      const list = document.getElementById('students-list');
      list.innerHTML = `<h4 style="margin: 20px 0 12px 0; color: #374151;">Estudiantes Registrados (General)</h4><div style="max-height: 300px; overflow-y: auto;"><p style="color: #6b7280; font-style: italic; padding: 10px;">Esta lista solo muestra datos del curso seleccionado si lo cargaste.</p></div>`;
    }
    
    function renderGroupsList() {
        const list = document.getElementById('groups-list');
        list.innerHTML = `<h4 style="margin: 20px 0 12px 0; color: #374151;">Grupos Registrados (General)</h4><div style="max-height: 300px; overflow-y: auto;"><p style="color: #6b7280; font-style: italic; padding: 10px;">Esta lista solo muestra datos del curso seleccionado si lo cargaste.</p></div>`;
    }
    
    function addStudent() { showToast('Funcionalidad de agregar estudiante requiere endpoint PHP', 'error'); }
    function addGroup() { showToast('Funcionalidad de agregar grupo requiere endpoint PHP', 'error'); }
    function removeStudent(id) { showToast('Funcionalidad de eliminar estudiante requiere endpoint PHP', 'error'); }
    function removeGroup(id) { showToast('Funcionalidad de eliminar grupo requiere endpoint PHP', 'error'); }
    
    // --- Event Listener de Env√≠o de Formulario ---
    document.getElementById('assignment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const cursoIDAsignacion = document.getElementById('select-curso-asignacion').value;
      const title = document.getElementById('eval-title').value.trim();
      const description = document.getElementById('eval-description').value.trim();
      const dueDate = document.getElementById('eval-due-date').value;
      const maxScore = parseInt(document.getElementById('eval-max-score').value);
      
      if (!cursoIDAsignacion) {
        showToast('Debes seleccionar un curso para asignar la evaluaci√≥n', 'error');
        return;
      }

      const selectedStudents = Array.from(document.querySelectorAll('#students-grid input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
      const selectedGroups = Array.from(document.querySelectorAll('#groups-grid input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
      
      if (selectedStudents.length === 0 && selectedGroups.length === 0) {
        showToast('Debes seleccionar al menos un estudiante o grupo', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submit-assignment-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span>Guardando...';
      
      const assignmentData = {
        cursoID: cursoIDAsignacion, 
        titulo: title, 
        descripcion: description,
        puntos: maxScore,
        fechaVencimiento: dueDate,
        assignedStudents: JSON.stringify(selectedStudents), 
        assignedGroups: JSON.stringify(selectedGroups),
        
        // Valores por defecto
        duracion: 60,
        totalPreguntas: 10,
        intentos: 1,
        requiereArchivo: 0
      };
      
      const formData = new FormData();
      for (const key in assignmentData) {
          formData.append(key, assignmentData[key]);
      }

      let result;
      let isEdit = document.getElementById('assignment-form').dataset.editId;
      
      if (isEdit) {
          // Simulaci√≥n de edici√≥n o uso de SDK
          // ...
          result = { status: 'success', message: 'Evaluaci√≥n actualizada correctamente'};
      } else {
        // Enviar a guardar_evaluacion.php
        const response = await fetch('guardar_evaluacion.php', {
            method: 'POST',
            body: formData
        });
        result = await response.json();
      }
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = isEdit ? 'Actualizar Asignaci√≥n' : 'Crear Asignaci√≥n';
      
      if (result.status === 'success' || (isEdit && result.isOk)) {
        showToast(isEdit ? 'Asignaci√≥n actualizada exitosamente' : result.message, 'success');
        document.getElementById('assignment-modal').classList.remove('active');
        // Limpiar formulario y grids
        document.getElementById('assignment-form').reset();
        document.getElementById('select-curso-asignacion').value = '';
        await loadStudentsAndGroups(null); 
        // L√≥gica de recarga de la lista de asignaciones aqu√≠
      } else {
        showToast(`Error al guardar: ${result.message || 'Error desconocido'}`, 'error');
      }
    });
    
    // Funci√≥n de Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Event Listeners (Asegura la apertura del modal)
    document.getElementById('create-assignment-btn').addEventListener('click', openAssignmentModal);
    
    document.getElementById('manage-students-btn').addEventListener('click', () => { document.getElementById('students-modal').classList.add('active'); });
    document.getElementById('manage-groups-btn').addEventListener('click', () => { document.getElementById('groups-modal').classList.add('active'); });
    document.getElementById('cancel-assignment-btn').addEventListener('click', () => { document.getElementById('assignment-modal').classList.remove('active'); });
    document.getElementById('close-students-btn').addEventListener('click', () => { document.getElementById('students-modal').classList.remove('active'); });
    document.getElementById('close-groups-btn').addEventListener('click', () => { document.getElementById('groups-modal').classList.remove('active'); });
    document.getElementById('add-student-btn').addEventListener('click', addStudent);
    document.getElementById('add-group-btn').addEventListener('click', addGroup);
    document.getElementById('status-filter').addEventListener('change', renderAssignments);
    document.getElementById('search-filter').addEventListener('input', renderAssignments);
    
    // --- Funciones de configuraci√≥n SDK (Mantener si usas ElementSDK) ---
    async function onConfigChange(config) {
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
      
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const successColor = config.success_color || defaultConfig.success_color;
      const dangerColor = config.danger_color || defaultConfig.danger_color;
      
      document.body.style.background = `linear-gradient(135deg, ${primaryColor} 0%, #7c3aed 100%)`;
      
      document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.style.background = primaryColor;
      });
      
      document.querySelectorAll('.btn-success').forEach(btn => {
        btn.style.background = successColor;
      });
      
      document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.style.background = dangerColor;
      });
      
      document.querySelectorAll('.header, .actions-bar, .assignment-card, .modal-content, .empty-state, .filter-bar').forEach(el => {
        el.style.background = secondaryColor;
      });
      
      document.querySelectorAll('h1, h2, h3, .assignment-title').forEach(el => {
        el.style.color = textColor;
      });
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.primary_color || defaultConfig.primary_color, set: (value) => { config.primary_color = value; window.elementSdk.setConfig({ primary_color: value }); } },
            { get: () => config.secondary_color || defaultConfig.secondary_color, set: (value) => { config.secondary_color = value; window.elementSdk.setConfig({ secondary_color: value }); } },
            { get: () => config.text_color || defaultConfig.text_color, set: (value) => { config.text_color = value; window.elementSdk.setConfig({ text_color: value }); } },
            { get: () => config.success_color || defaultConfig.success_color, set: (value) => { config.success_color = value; window.elementSdk.setConfig({ success_color: value }); } },
            { get: () => config.danger_color || defaultConfig.danger_color, set: (value) => { config.danger_color = value; window.elementSdk.setConfig({ danger_color: value }); } }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
        ])
      });
    }
    
    initializeApp();
  </script>
</body>
</html>